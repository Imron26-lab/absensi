<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
        }
        .tab-active {
            background-color: #4f46e5;
            color: white;
        }
        .tab-inactive {
            background-color: #e5e7eb;
            color: #4b5563;
        }
        .notification {
            transform: translateY(-100px);
            transition: transform 0.5s ease;
        }
        .notification.show {
            transform: translateY(0);
        }
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="notification fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50" id="notification">
        Absen berhasil disimpan!
    </div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="flex no-print">
                <button id="tab1-btn" class="tab-active flex-1 py-4 font-medium text-center transition-all duration-200">
                    Absensi Harian
                </button>
                <button id="tab2-btn" class="tab-inactive flex-1 py-4 font-medium text-center transition-all duration-200">
                    Rekap Absensi
                </button>
                <button id="tab3-btn" class="tab-inactive flex-1 py-4 font-medium text-center transition-all duration-200">
                    Manajemen Kelas
                </button>
            </div>

            <div id="tab1" class="p-6">
                <div class="mb-8 text-center">
                    <div class="mb-4">
                        <h2 class="text-lg font-medium text-indigo-700 mb-2">Pilih Sekolah</h2>
                        <div class="flex justify-center gap-4">
                            <button id="sekolah-budi-agung" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">SMK Pariwisata Budi Agung</button>
                            <button id="sekolah-sumbangsih" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">SMK Pariwisata Sumbangsih</button>
                        </div>
                    </div>
                    <h1 class="text-3xl font-bold text-indigo-700" id="nama-sekolah">SMK Pariwisata Budi Agung</h1>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Guru</h2>
                            <p class="mt-1" id="nama-guru">MOHAMAD AL-IMRON, S.KOM</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Mata Pelajaran</h2>
                            <p class="mt-1" id="mata-pelajaran">Simulasi Digital dan Komunikasi</p>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Kelas</h2>
                            <select id="pilih-kelas" class="mt-1 w-full p-2 border border-indigo-200 rounded-md">
                                <option value="">Pilih Kelas</option>
                                </select>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Tanggal</h2>
                            <input type="date" id="tanggal" class="mt-1 w-full p-2 border border-indigo-200 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Materi Pembahasan</h2>
                             <select id="pilih-materi" class="mt-1 w-full p-2 border border-indigo-200 rounded-md">
                                <option value="">Pilih Materi</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="flex flex-wrap gap-3 mb-6">
                    <button id="hadir-semua" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all">
                        Hadir Semua
                    </button>
                    <button id="tambah-siswa" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">
                        Tambah Siswa
                    </button>
                    <button id="simpan-absen" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-all">
                        Simpan Absen
                    </button>
                    <button id="ekspor-excel" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-all">
                        Ekspor ke Excel
                    </button>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-indigo-600 text-white">
                                <th class="py-3 px-4 text-left">No</th>
                                <th class="py-3 px-4 text-left">NISN</th>
                                <th class="py-3 px-4 text-left">Nama</th>
                                <th class="py-3 px-4 text-center">Hadir</th>
                                <th class="py-3 px-4 text-center">Izin</th>
                                <th class="py-3 px-4 text-center">Sakit</th>
                                <th class="py-3 px-4 text-center">Absen</th>
                                <th class="py-3 px-4 text-center">Nilai</th>
                                <th class="py-3 px-4 text-left">Keterangan</th>
                                <th class="py-3 px-4 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-siswa">
                            </tbody>
                    </table>
                </div>
            </div>

            <div id="tab2" class="p-6 hidden">
                 <div class="mb-6 flex flex-wrap justify-between items-center">
                    <h2 class="text-2xl font-bold text-indigo-700">Rekap Absensi</h2>
                    <div class="flex gap-3 mt-4 sm:mt-0">
                        <button id="cetak-rekap" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg transition-all no-print">
                            Cetak Rekap
                        </button>
                        <button id="ekspor-rekap" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-all no-print">
                            Ekspor Rekap ke Excel
                        </button>
                    </div>
                </div>

                <div class="mb-6 flex gap-4 no-print">
                    <button id="rekap-harian-btn" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">Rekap Harian</button>
                    <button id="rekap-bulanan-btn" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">Rekap Bulanan</button>
                </div>

                <div class="mb-6 grid grid-cols-1 md:grid-cols-3 gap-4 no-print">
                    <div id="filter-harian" class="bg-indigo-50 p-4 rounded-lg">
                        <h3 class="font-medium text-indigo-700 mb-2">Pilih Tanggal</h3>
                        <input type="date" id="filter-tanggal" class="w-full p-2 border border-indigo-200 rounded-md">
                    </div>
                    <div id="filter-bulanan" class="bg-indigo-50 p-4 rounded-lg hidden">
                        <h3 class="font-medium text-indigo-700 mb-2">Pilih Bulan</h3>
                        <input type="month" id="filter-bulan" class="w-full p-2 border border-indigo-200 rounded-md">
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <h3 class="font-medium text-indigo-700 mb-2">Sekolah</h3>
                        <p id="rekap-sekolah" class="mt-1">SMK Pariwisata Budi Agung</p>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <h3 class="font-medium text-indigo-700 mb-2">Kelas</h3>
                        <select id="filter-kelas" class="w-full p-2 border border-indigo-200 rounded-md">
                            <option value="">Semua Kelas</option>
                            </select>
                    </div>
                    <div class="bg-indigo-50 p-4 rounded-lg">
                        <h3 class="font-medium text-indigo-700 mb-2">Mata Pelajaran</h3>
                        <p id="rekap-mapel" class="mt-1">Simulasi Digital dan Komunikasi</p>
                    </div>
                </div>

                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead>
                            <tr class="bg-indigo-600 text-white">
                                <th class="py-3 px-4 text-left">No</th>
                                <th class="py-3 px-4 text-left">NISN</th>
                                <th class="py-3 px-4 text-left">Nama</th>
                                <th class="py-3 px-4 text-center">Hadir</th>
                                <th class="py-3 px-4 text-center">Izin</th>
                                <th class="py-3 px-4 text-center">Sakit</th>
                                <th class="py-3 px-4 text-center">Absen</th>
                                <th class="py-3 px-4 text-center">Nilai Rata-rata</th>
                                <th class="py-3 px-4 text-left">Keterangan</th>
                            </tr>
                        </thead>
                        <tbody id="rekap-siswa">
                            </tbody>
                    </table>
                </div>

                <div class="mt-8 grid grid-cols-1 md:grid-cols-5 gap-4">
                    <div class="bg-green-100 p-4 rounded-lg text-center">
                        <h3 class="font-medium text-green-700">Total Hadir</h3>
                        <p id="total-hadir" class="text-2xl font-bold text-green-700 mt-2">0</p>
                    </div>
                    <div class="bg-blue-100 p-4 rounded-lg text-center">
                        <h3 class="font-medium text-blue-700">Total Izin</h3>
                        <p id="total-izin" class="text-2xl font-bold text-blue-700 mt-2">0</p>
                    </div>
                    <div class="bg-yellow-100 p-4 rounded-lg text-center">
                        <h3 class="font-medium text-yellow-700">Total Sakit</h3>
                        <p id="total-sakit" class="text-2xl font-bold text-yellow-700 mt-2">0</p>
                    </div>
                    <div class="bg-red-100 p-4 rounded-lg text-center">
                        <h3 class="font-medium text-red-700">Total Absen</h3>
                        <p id="total-absen" class="text-2xl font-bold text-red-700 mt-2">0</p>
                    </div>
                    <div class="bg-purple-100 p-4 rounded-lg text-center">
                        <h3 class="font-medium text-purple-700">Nilai Rata-rata</h3>
                        <p id="total-nilai" class="text-2xl font-bold text-purple-700 mt-2">0</p>
                    </div>
                </div>
            </div>

            <div id="tab3" class="p-6 hidden">
                <div class="mb-6 flex flex-wrap justify-between items-center">
                    <h2 class="text-2xl font-bold text-indigo-700">Manajemen Kelas</h2>
                    <div class="flex gap-3 mt-4 sm:mt-0">
                        <button id="tambah-kelas" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-all">
                            Tambah Kelas Baru
                        </button>
                    </div>
                </div>

                <div class="mb-6">
                    <h3 class="text-lg font-medium text-indigo-700 mb-2">Pilih Sekolah</h3>
                    <div class="flex gap-4">
                        <button id="kelas-budi-agung" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">SMK Pariwisata Budi Agung</button>
                        <button id="kelas-sumbangsih" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">SMK Pariwisata Sumbangsih</button>
                    </div>
                </div>

                <div class="mb-8">
                    <h3 class="text-lg font-medium text-indigo-700 mb-4">Daftar Kelas</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="daftar-kelas">
                        </div>
                </div>

                <div id="detail-kelas" class="hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-medium text-indigo-700">Detail Kelas: <span id="nama-kelas-detail">-</span></h3>
                        <div class="flex gap-2">
                            <button id="edit-kelas" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-lg">Edit Kelas</button>
                            <button id="hapus-kelas" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded-lg">Hapus Kelas</button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                             <h4 class="text-lg font-medium text-indigo-700 mb-4">Daftar Siswa</h4>
                            <div class="mb-4 flex flex-wrap gap-3">
                                <button id="tambah-siswa-kelas" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">
                                    Tambah Siswa
                                </button>
                                <button id="import-siswa" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all">
                                    Import Siswa
                                </button>
                                <button id="export-template" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-all">
                                    Download Template
                                </button>
                            </div>

                            <div class="overflow-x-auto max-h-96">
                                <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                                    <thead>
                                        <tr class="bg-indigo-600 text-white">
                                            <th class="py-3 px-4 text-left">No</th>
                                            <th class="py-3 px-4 text-left">NISN</th>
                                            <th class="py-3 px-4 text-left">Nama</th>
                                            <th class="py-3 px-4 text-center">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody id="siswa-dalam-kelas">
                                        </tbody>
                                </table>
                            </div>
                        </div>

                        <div>
                            <h4 class="text-lg font-medium text-indigo-700 mb-4">Daftar Materi Pembahasan</h4>
                            <div class="flex gap-2 mb-4">
                                <input type="text" id="input-materi-baru" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Masukkan materi baru...">
                                <button id="tambah-materi" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg">Tambah</button>
                            </div>
                            <div id="daftar-materi" class="space-y-2 max-h-80 overflow-y-auto bg-gray-50 p-3 rounded-lg">
                                </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-tambah-siswa" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Tambah Siswa Baru</h2>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">NISN</label>
                <input type="text" id="new-nisn" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Nama</label>
                <input type="text" id="new-nama" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Kelas</label>
                <select id="new-kelas" class="w-full p-2 border border-gray-300 rounded-md">
                    <option value="">Pilih Kelas</option>
                    </select>
            </div>
            <div class="flex justify-end gap-2">
                <button id="batal-tambah" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Batal</button>
                <button id="simpan-tambah" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="modal-edit-siswa" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Edit Siswa</h2>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">NISN</label>
                <input type="text" id="edit-nisn" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Nama</label>
                <input type="text" id="edit-nama" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Kelas</label>
                <select id="edit-kelas-select" class="w-full p-2 border border-gray-300 rounded-md">
                    <option value="">Pilih Kelas</option>
                    </select>
            </div>
            <input type="hidden" id="edit-siswa-id">
            <div class="flex justify-end gap-2">
                <button id="batal-edit" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Batal</button>
                <button id="simpan-edit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="modal-tambah-kelas" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Tambah Kelas Baru</h2>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Nama Kelas</label>
                <input type="text" id="new-nama-kelas" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Contoh: X RPL 1">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Wali Kelas</label>
                <input type="text" id="new-wali-kelas" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="flex justify-end gap-2">
                <button id="batal-tambah-kelas" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Batal</button>
                <button id="simpan-tambah-kelas" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="modal-edit-kelas" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Edit Kelas</h2>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Nama Kelas</label>
                <input type="text" id="edit-nama-kelas" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 mb-2">Wali Kelas</label>
                <input type="text" id="edit-wali-kelas" class="w-full p-2 border border-gray-300 rounded-md">
            </div>
            <input type="hidden" id="edit-kelas-id">
            <div class="flex justify-end gap-2">
                <button id="batal-edit-kelas" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Batal</button>
                <button id="simpan-edit-kelas" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

    <div id="modal-import-siswa" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Import Siswa</h2>
            <div class="mb-4">
                <p class="text-gray-600 mb-2">Upload file Excel (.xlsx) atau CSV yang berisi data siswa.</p>
                <p class="text-gray-600 mb-4">Format: NISN, Nama Siswa</p>
                <label class="block w-full p-3 border-2 border-dashed border-indigo-300 rounded-lg text-center cursor-pointer hover:bg-indigo-50 transition-all">
                    <span class="text-indigo-600 font-medium">Pilih File</span>
                    <input type="file" id="file-import" class="hidden" accept=".xlsx,.xls,.csv">
                </label>
                <p id="selected-file" class="mt-2 text-sm text-gray-500">Belum ada file yang dipilih</p>
            </div>
            <div class="flex justify-end gap-2">
                <button id="batal-import" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Batal</button>
                <button id="proses-import" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Import</button>
            </div>
        </div>
    </div>

    <div id="modal-preview-import" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl max-h-[80vh] overflow-y-auto">
            <h2 class="text-xl font-bold mb-4">Preview Data Import</h2>
            <p class="text-gray-600 mb-4">Berikut adalah data yang akan diimport ke kelas <span id="preview-nama-kelas" class="font-medium"></span>.</p>
            
            <div class="overflow-x-auto mb-4">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                    <thead>
                        <tr class="bg-indigo-600 text-white">
                            <th class="py-3 px-4 text-left">No</th>
                            <th class="py-3 px-4 text-left">NISN</th>
                            <th class="py-3 px-4 text-left">Nama</th>
                            <th class="py-3 px-4 text-center">Status</th>
                        </tr>
                    </thead>
                    <tbody id="preview-data">
                        </tbody>
                </table>
            </div>
            
            <div class="flex justify-end gap-2">
                <button id="batal-preview" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Batal</button>
                <button id="konfirmasi-import" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Konfirmasi Import</button>
            </div>
        </div>
    </div>

    <script>
        // PERUBAHAN: Menambahkan 'materi' ke dalam data kelas
        let kelasBudiAgung = [
            { id: 1, nama: "X RPL 1", waliKelas: "Budi Santoso", materi: ["Pengenalan Algoritma", "Dasar HTML & CSS"] },
            { id: 2, nama: "X RPL 2", waliKelas: "Siti Aminah", materi: ["Variabel dan Tipe Data", "Struktur Kontrol"] }
        ];
        
        let kelasSumbangsih = [
            { id: 1, nama: "X TKJ 1", waliKelas: "Ahmad Fauzi", materi: ["Pengenalan Jaringan", "Topologi Jaringan"] },
            { id: 2, nama: "X TKJ 2", waliKelas: "Dewi Lestari", materi: ["Instalasi Sistem Operasi", "Setting IP Address"] }
        ];
        
        // Data siswa
        let siswaListBudiAgung = [
            { id: 1, nisn: "0001", nama: "Yuli", status: "", nilai: "", keterangan: "", kelasId: 1 },
            { id: 2, nisn: "0002", nama: "Risma", status: "", nilai: "", keterangan: "", kelasId: 1 },
            { id: 3, nisn: "0003", nama: "Doni", status: "", nilai: "", keterangan: "", kelasId: 2 },
            { id: 4, nisn: "0004", nama: "Rina", status: "", nilai: "", keterangan: "", kelasId: 2 }
        ];
        
        let siswaListSumbangsih = [
            { id: 1, nisn: "1001", nama: "Ahmad", status: "", nilai: "", keterangan: "", kelasId: 1 },
            { id: 2, nisn: "1002", nama: "Budi", status: "", nilai: "", keterangan: "", kelasId: 1 },
            { id: 3, nisn: "1003", nama: "Cindy", status: "", nilai: "", keterangan: "", kelasId: 2 },
            { id: 4, nisn: "1004", nama: "Dina", status: "", nilai: "", keterangan: "", kelasId: 2 }
        ];
        
        let siswaList = [...siswaListBudiAgung];
        let kelasList = [...kelasBudiAgung];
        let selectedKelasId = null;
        let importData = [];

        // Data absensi yang tersimpan
        let absensiData = [];

        // Fungsi untuk menampilkan notifikasi
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            
            notification.classList.remove('bg-green-500', 'bg-blue-500', 'bg-red-500');
            if (type === 'info') {
                notification.classList.add('bg-blue-500');
            } else if(type === 'error') {
                 notification.classList.add('bg-red-500');
            } else {
                notification.classList.add('bg-green-500');
            }

            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // PERUBAHAN: Fungsi memuat data absensi & materi
        function loadOrClearAbsensi() {
            const tanggal = document.getElementById('tanggal').value;
            const namaSekolah = document.getElementById('nama-sekolah').textContent;
            const kelasIdValue = document.getElementById('pilih-kelas').value;
            
            // Populate dropdown materi setiap kali kelas berubah
            populateMateriDropdown(kelasIdValue);

            if (!kelasIdValue) {
                document.getElementById('daftar-siswa').innerHTML = '<tr class="bg-gray-50"><td colspan="10" class="text-center py-4 text-gray-500">Silakan pilih kelas untuk menampilkan siswa.</td></tr>';
                return;
            }
            
            const kelasId = parseInt(kelasIdValue);

            const savedEntry = absensiData.find(data =>
                data.tanggal === tanggal &&
                data.namaSekolah === namaSekolah &&
                data.kelasId === kelasId
            );

            const studentsInSelectedClass = siswaList.filter(s => s.kelasId === kelasId);

            if (savedEntry) {
                // Muat materi yang tersimpan ke dropdown
                document.getElementById('pilih-materi').value = savedEntry.materi || '';
                
                studentsInSelectedClass.forEach(currentSiswa => {
                    const savedSiswa = savedEntry.siswa.find(s => s.id === currentSiswa.id);
                    if (savedSiswa) {
                        currentSiswa.status = savedSiswa.status;
                        currentSiswa.nilai = savedSiswa.nilai;
                        currentSiswa.keterangan = savedSiswa.keterangan;
                    } else {
                        currentSiswa.status = '';
                        currentSiswa.nilai = '';
                        currentSiswa.keterangan = '';
                    }
                });
                showNotification(`Data absen untuk tanggal ${tanggal} berhasil dimuat.`, 'info');
            } else {
                // Reset dropdown materi dan data siswa
                 document.getElementById('pilih-materi').value = '';
                studentsInSelectedClass.forEach(currentSiswa => {
                    currentSiswa.status = '';
                    currentSiswa.nilai = '';
                    currentSiswa.keterangan = '';
                });
            }
            renderDaftarSiswa();
        }

        function renderDaftarSiswa() {
            const daftarSiswa = document.getElementById('daftar-siswa');
            daftarSiswa.innerHTML = '';
            
            const kelasId = document.getElementById('pilih-kelas').value;
            if (!kelasId) {
                daftarSiswa.innerHTML = '<tr class="bg-gray-50"><td colspan="10" class="text-center py-4 text-gray-500">Silakan pilih kelas untuk menampilkan siswa.</td></tr>';
                return;
            }

            const filteredSiswa = siswaList.filter(siswa => siswa.kelasId === parseInt(kelasId));

            if (filteredSiswa.length === 0) {
                daftarSiswa.innerHTML = '<tr class="bg-gray-50"><td colspan="10" class="text-center py-4 text-gray-500">Tidak ada siswa di kelas ini.</td></tr>';
                return;
            }

            filteredSiswa.forEach((siswa, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                
                // PERUBAHAN: Kolom keterangan diganti menjadi 'keterangan'
                row.innerHTML = `
                    <td class="py-3 px-4">${index + 1}</td>
                    <td class="py-3 px-4">${siswa.nisn}</td>
                    <td class="py-3 px-4">${siswa.nama}</td>
                    <td class="py-3 px-4 text-center">
                        <input type="radio" name="status-${siswa.id}" value="hadir" ${siswa.status === 'hadir' ? 'checked' : ''} class="w-4 h-4 text-green-600">
                    </td>
                    <td class="py-3 px-4 text-center">
                        <input type="radio" name="status-${siswa.id}" value="izin" ${siswa.status === 'izin' ? 'checked' : ''} class="w-4 h-4 text-blue-600">
                    </td>
                    <td class="py-3 px-4 text-center">
                        <input type="radio" name="status-${siswa.id}" value="sakit" ${siswa.status === 'sakit' ? 'checked' : ''} class="w-4 h-4 text-yellow-600">
                    </td>
                    <td class="py-3 px-4 text-center">
                        <input type="radio" name="status-${siswa.id}" value="absen" ${siswa.status === 'absen' ? 'checked' : ''} class="w-4 h-4 text-red-600">
                    </td>
                    <td class="py-3 px-4 text-center">
                        <input type="number" min="0" max="100" value="${siswa.nilai || ''}" class="nilai-${siswa.id} w-full p-1 border border-gray-300 rounded-md" placeholder="0-100">
                    </td>
                    <td class="py-3 px-4">
                        <input type="text" value="${siswa.keterangan || ''}" class="keterangan-${siswa.id} w-full p-1 border border-gray-300 rounded-md">
                    </td>
                    <td class="py-3 px-4 text-center">
                        <button class="edit-siswa bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded mr-1" data-id="${siswa.id}">Edit</button>
                        <button class="hapus-siswa bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-id="${siswa.id}">Hapus</button>
                    </td>
                `;
                
                daftarSiswa.appendChild(row);
            });

            document.querySelectorAll('.hapus-siswa').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('Apakah Anda yakin ingin menghapus siswa ini?')) {
                        siswaList = siswaList.filter(siswa => siswa.id !== id);
                        
                        if (document.getElementById('nama-sekolah').textContent === 'SMK Pariwisata Budi Agung') {
                            siswaListBudiAgung = siswaListBudiAgung.filter(s => s.id !== id);
                        } else {
                            siswaListSumbangsih = siswaListSumbangsih.filter(s => s.id !== id);
                        }
                        
                        renderDaftarSiswa();
                        showNotification('Siswa berhasil dihapus!');
                    }
                });
            });
            
            document.querySelectorAll('.edit-siswa').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    const siswa = siswaList.find(s => s.id === id);
                    
                    if (siswa) {
                        document.getElementById('edit-siswa-id').value = siswa.id;
                        document.getElementById('edit-nisn').value = siswa.nisn;
                        document.getElementById('edit-nama').value = siswa.nama;
                        document.getElementById('edit-kelas-select').value = siswa.kelasId || '';
                        
                        document.getElementById('modal-edit-siswa').classList.remove('hidden');
                    }
                });
            });
        }
        
        // Fungsi rekap tidak berubah signifikan
        function renderRekapAbsensi(filter = {}) {
            const rekapSiswa = document.getElementById('rekap-siswa');
            rekapSiswa.innerHTML = '';
            
            let filteredData = [...absensiData];
            
            const sekolah = document.getElementById('rekap-sekolah').textContent;
            filteredData = filteredData.filter(data => data.namaSekolah === sekolah);
            
            const kelasFilter = document.getElementById('filter-kelas').value;
            if (kelasFilter) {
                filteredData = filteredData.filter(data => data.kelasId === parseInt(kelasFilter));
            }
            
            if (filter.tanggal) {
                filteredData = filteredData.filter(data => data.tanggal === filter.tanggal);
            } else if (filter.bulan) {
                filteredData = filteredData.filter(data => data.tanggal.startsWith(filter.bulan));
            }
            
            if (filteredData.length === 0) {
                rekapSiswa.innerHTML = `<tr><td colspan="9" class="py-4 px-4 text-center text-gray-500">Tidak ada data absensi yang tersedia</td></tr>`;
                document.getElementById('total-hadir').textContent = '0';
                document.getElementById('total-izin').textContent = '0';
                document.getElementById('total-sakit').textContent = '0';
                document.getElementById('total-absen').textContent = '0';
                document.getElementById('total-nilai').textContent = '0';
                return;
            }
            
            let totalHadir = 0, totalIzin = 0, totalSakit = 0, totalAbsen = 0, totalNilai = 0, totalSiswaWithNilai = 0;
            
            if (filter.bulan) {
                const siswaMap = new Map();
                
                filteredData.forEach(data => {
                    data.siswa.forEach(siswa => {
                        if (!siswaMap.has(siswa.id)) {
                            siswaMap.set(siswa.id, {
                                id: siswa.id, nisn: siswa.nisn, nama: siswa.nama,
                                hadir: 0, izin: 0, sakit: 0, absen: 0,
                                nilai: [], keterangan: []
                            });
                        }
                        
                        const siswaData = siswaMap.get(siswa.id);
                        if (siswa.status === 'hadir') siswaData.hadir++;
                        else if (siswa.status === 'izin') siswaData.izin++;
                        else if (siswa.status === 'sakit') siswaData.sakit++;
                        else if (siswa.status === 'absen') siswaData.absen++;
                        
                        if (siswa.nilai) siswaData.nilai.push(parseFloat(siswa.nilai));
                        if (siswa.keterangan) siswaData.keterangan.push(`${data.tanggal}: ${siswa.keterangan}`);
                    });
                });
                
                Array.from(siswaMap.values()).forEach((siswa, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                    let nilaiRataRata = 0;
                    if (siswa.nilai.length > 0) {
                        nilaiRataRata = siswa.nilai.reduce((a, b) => a + b, 0) / siswa.nilai.length;
                        totalNilai += nilaiRataRata;
                        totalSiswaWithNilai++;
                    }
                    row.innerHTML = `
                        <td class="py-3 px-4">${index + 1}</td> <td class="py-3 px-4">${siswa.nisn}</td>
                        <td class="py-3 px-4">${siswa.nama}</td> <td class="py-3 px-4 text-center">${siswa.hadir}</td>
                        <td class="py-3 px-4 text-center">${siswa.izin}</td> <td class="py-3 px-4 text-center">${siswa.sakit}</td>
                        <td class="py-3 px-4 text-center">${siswa.absen}</td> <td class="py-3 px-4 text-center">${nilaiRataRata.toFixed(1)}</td>
                        <td class="py-3 px-4">${siswa.keterangan.join('; ')}</td>
                    `;
                    rekapSiswa.appendChild(row);
                    totalHadir += siswa.hadir; totalIzin += siswa.izin; totalSakit += siswa.sakit; totalAbsen += siswa.absen;
                });
            } else {
                const data = filteredData[0];
                if (data) {
                    data.siswa.forEach((siswa, index) => {
                        const row = document.createElement('tr');
                        row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                        if (siswa.nilai) {
                            totalNilai += parseFloat(siswa.nilai);
                            totalSiswaWithNilai++;
                        }
                        row.innerHTML = `
                            <td class="py-3 px-4">${index + 1}</td> <td class="py-3 px-4">${siswa.nisn}</td>
                            <td class="py-3 px-4">${siswa.nama}</td> <td class="py-3 px-4 text-center">${siswa.status === 'hadir' ? '✓' : ''}</td>
                            <td class="py-3 px-4 text-center">${siswa.status === 'izin' ? '✓' : ''}</td> <td class="py-3 px-4 text-center">${siswa.status === 'sakit' ? '✓' : ''}</td>
                            <td class="py-3 px-4 text-center">${siswa.status === 'absen' ? '✓' : ''}</td> <td class="py-3 px-4 text-center">${siswa.nilai || '-'}</td>
                            <td class="py-3 px-4">${siswa.keterangan || ''}</td>
                        `;
                        rekapSiswa.appendChild(row);
                        if (siswa.status === 'hadir') totalHadir++; else if (siswa.status === 'izin') totalIzin++;
                        else if (siswa.status === 'sakit') totalSakit++; else if (siswa.status === 'absen') totalAbsen++;
                    });
                }
            }
            
            document.getElementById('total-hadir').textContent = totalHadir;
            document.getElementById('total-izin').textContent = totalIzin;
            document.getElementById('total-sakit').textContent = totalSakit;
            document.getElementById('total-absen').textContent = totalAbsen;
            const nilaiRataRataKelas = totalSiswaWithNilai > 0 ? (totalNilai / totalSiswaWithNilai).toFixed(1) : '0';
            document.getElementById('total-nilai').textContent = nilaiRataRataKelas;
        }

        function renderDaftarKelas() {
            const daftarKelas = document.getElementById('daftar-kelas');
            daftarKelas.innerHTML = '';
            
            kelasList.forEach(kelas => {
                const kelasCard = document.createElement('div');
                kelasCard.className = 'bg-white p-4 rounded-lg shadow-md border border-gray-200 hover:border-indigo-500 cursor-pointer transition-all';
                kelasCard.setAttribute('data-id', kelas.id);
                
                const jumlahSiswa = siswaList.filter(siswa => siswa.kelasId === kelas.id).length;
                
                kelasCard.innerHTML = `
                    <h4 class="text-lg font-medium text-indigo-700">${kelas.nama}</h4>
                    <p class="text-gray-600 mt-1">Wali Kelas: ${kelas.waliKelas}</p>
                    <p class="text-gray-600 mt-1">Jumlah Siswa: ${jumlahSiswa}</p>
                `;
                
                daftarKelas.appendChild(kelasCard);
                
                kelasCard.addEventListener('click', function() {
                    const kelasId = parseInt(this.getAttribute('data-id'));
                    selectedKelasId = kelasId;
                    
                    document.getElementById('detail-kelas').classList.remove('hidden');
                    document.getElementById('nama-kelas-detail').textContent = kelas.nama;
                    
                    renderSiswaDalamKelas(kelasId);
                    // FITUR BARU: Render daftar materi saat kelas dipilih
                    renderMateriList(kelasId);
                });
            });
        }
        
        function renderSiswaDalamKelas(kelasId) {
            const siswaDalamKelas = document.getElementById('siswa-dalam-kelas');
            siswaDalamKelas.innerHTML = '';
            
            const siswaKelas = siswaList.filter(siswa => siswa.kelasId === kelasId);
            
            if (siswaKelas.length === 0) {
                siswaDalamKelas.innerHTML = `<tr><td colspan="4" class="py-4 px-4 text-center text-gray-500">Belum ada siswa dalam kelas ini</td></tr>`;
                return;
            }
            
            siswaKelas.forEach((siswa, index) => {
                const row = document.createElement('tr');
                row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                
                row.innerHTML = `
                    <td class="py-3 px-4">${index + 1}</td>
                    <td class="py-3 px-4">${siswa.nisn}</td>
                    <td class="py-3 px-4">${siswa.nama}</td>
                    <td class="py-3 px-4 text-center">
                        <button class="edit-siswa-kelas bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded mr-1" data-id="${siswa.id}">Edit</button>
                        <button class="hapus-siswa-kelas bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded" data-id="${siswa.id}">Hapus</button>
                    </td>
                `;
                
                siswaDalamKelas.appendChild(row);
            });
            
            document.querySelectorAll('.hapus-siswa-kelas').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    if (confirm('Apakah Anda yakin ingin menghapus siswa ini?')) {
                        siswaList = siswaList.filter(siswa => siswa.id !== id);
                        
                        if (document.getElementById('kelas-budi-agung').classList.contains('bg-indigo-600')) {
                            siswaListBudiAgung = siswaListBudiAgung.filter(s => s.id !== id);
                        } else {
                             siswaListSumbangsih = siswaListSumbangsih.filter(s => s.id !== id);
                        }
                        
                        renderSiswaDalamKelas(kelasId);
                        showNotification('Siswa berhasil dihapus!');
                    }
                });
            });
            
            document.querySelectorAll('.edit-siswa-kelas').forEach(button => {
                button.addEventListener('click', function() {
                    const id = parseInt(this.getAttribute('data-id'));
                    const siswa = siswaList.find(s => s.id === id);
                    
                    if (siswa) {
                        document.getElementById('edit-siswa-id').value = siswa.id;
                        document.getElementById('edit-nisn').value = siswa.nisn;
                        document.getElementById('edit-nama').value = siswa.nama;
                        document.getElementById('edit-kelas-select').value = siswa.kelasId || '';
                        
                        document.getElementById('modal-edit-siswa').classList.remove('hidden');
                    }
                });
            });
        }
        
        // FITUR BARU: Fungsi untuk render daftar materi
        function renderMateriList(kelasId) {
            const daftarMateriContainer = document.getElementById('daftar-materi');
            daftarMateriContainer.innerHTML = '';
            const kelas = kelasList.find(k => k.id === kelasId);

            if (!kelas || !kelas.materi || kelas.materi.length === 0) {
                daftarMateriContainer.innerHTML = `<p class="text-gray-500 text-center">Belum ada materi untuk kelas ini.</p>`;
                return;
            }

            kelas.materi.forEach((materi, index) => {
                const materiItem = document.createElement('div');
                materiItem.className = 'flex justify-between items-center bg-white p-2 rounded-md shadow-sm';
                materiItem.innerHTML = `
                    <span class="text-gray-700">${materi}</span>
                    <button data-index="${index}" class="hapus-materi text-red-500 hover:text-red-700 font-bold">&times;</button>
                `;
                daftarMateriContainer.appendChild(materiItem);
            });

            // Event listener untuk hapus materi
            document.querySelectorAll('.hapus-materi').forEach(btn => {
                btn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    kelas.materi.splice(index, 1);
                    
                    if (document.getElementById('kelas-budi-agung').classList.contains('bg-indigo-600')) {
                        localStorage.setItem('kelasBudiAgung', JSON.stringify(kelasBudiAgung));
                    } else {
                        localStorage.setItem('kelasSumbangsih', JSON.stringify(kelasSumbangsih));
                    }
                    
                    renderMateriList(kelasId);
                    showNotification('Materi berhasil dihapus!');
                });
            });
        }
        
        // FITUR BARU: Fungsi untuk mengisi dropdown materi
        function populateMateriDropdown(kelasId) {
            const dropdown = document.getElementById('pilih-materi');
            dropdown.innerHTML = '<option value="">Pilih Materi</option>';
            if (!kelasId) return;

            const kelas = kelasList.find(k => k.id === parseInt(kelasId));
            if (kelas && kelas.materi) {
                kelas.materi.forEach(materi => {
                    const option = document.createElement('option');
                    option.value = materi;
                    option.textContent = materi;
                    dropdown.appendChild(option);
                });
            }
        }


        function populateKelasDropdown() {
            const dropdowns = [
                document.getElementById('pilih-kelas'),
                document.getElementById('filter-kelas'),
                document.getElementById('new-kelas'),
                document.getElementById('edit-kelas-select')
            ];
            
            dropdowns.forEach((dropdown, index) => {
                const firstOptionText = index === 0 || index === 2 || index === 3 ? "Pilih Kelas" : "Semua Kelas";
                const selectedValue = dropdown.value;
                dropdown.innerHTML = `<option value="">${firstOptionText}</option>`;
                
                kelasList.forEach(kelas => {
                    const option = document.createElement('option');
                    option.value = kelas.id;
                    option.textContent = kelas.nama;
                    dropdown.appendChild(option);
                });
                dropdown.value = selectedValue;
            });
        }
        
        function createExcelTemplate() {
            const data = [
                ['Template Import Siswa'],
                ['Instruksi: Isi data siswa pada kolom di bawah ini. Jangan ubah header kolom.'],
                [],
                ['NISN', 'Nama Siswa']
            ];
            for (let i = 0; i < 5; i++) { data.push(['', '']); }
            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Template');
            XLSX.writeFile(wb, 'Template_Import_Siswa.xlsx');
        }

        function readExcelFile(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const data = e.target.result;
                        const workbook = XLSX.read(data, { type: 'binary' });
                        const firstSheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[firstSheetName];
                        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                        
                        let headerRow = -1;
                        for (let i = 0; i < jsonData.length; i++) {
                            if (jsonData[i].length >= 2 &&  String(jsonData[i][0]).toUpperCase().includes('NISN') &&  String(jsonData[i][1]).toUpperCase().includes('NAMA')) {
                                headerRow = i; break;
                            }
                        }
                        
                        if (headerRow === -1) {
                            reject('Format file tidak valid. Header NISN dan Nama Siswa tidak ditemukan.'); return;
                        }
                        
                        const siswaData = [];
                        for (let i = headerRow + 1; i < jsonData.length; i++) {
                            if (jsonData[i].length >= 2 && jsonData[i][0] && jsonData[i][1]) {
                                siswaData.push({ nisn: String(jsonData[i][0]), nama: String(jsonData[i][1]) });
                            }
                        }
                        resolve(siswaData);
                    } catch (error) {
                        reject('Terjadi kesalahan saat membaca file: ' + error.message);
                    }
                };
                reader.onerror = function() { reject('Terjadi kesalahan saat membaca file.'); };
                reader.readAsBinaryString(file);
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggal').value = today;
            document.getElementById('filter-tanggal').value = today;
            const currentMonth = today.substring(0, 7);
            document.getElementById('filter-bulan').value = currentMonth;
            
            // Load data dari localStorage
            absensiData = JSON.parse(localStorage.getItem('absensiData') || '[]');
            siswaListBudiAgung = JSON.parse(localStorage.getItem('siswaListBudiAgung')) || siswaListBudiAgung;
            siswaListSumbangsih = JSON.parse(localStorage.getItem('siswaListSumbangsih')) || siswaListSumbangsih;
            kelasBudiAgung = JSON.parse(localStorage.getItem('kelasBudiAgung')) || kelasBudiAgung;
            kelasSumbangsih = JSON.parse(localStorage.getItem('kelasSumbangsih')) || kelasSumbangsih;

            siswaList = [...siswaListBudiAgung];
            kelasList = [...kelasBudiAgung];
            
            populateKelasDropdown();
            renderDaftarSiswa();
            renderDaftarKelas();
            
            document.getElementById('tanggal').addEventListener('change', loadOrClearAbsensi);
            document.getElementById('filter-tanggal').addEventListener('change', function() { renderRekapAbsensi({ tanggal: this.value }); });
            document.getElementById('filter-bulan').addEventListener('change', function() { renderRekapAbsensi({ bulan: this.value }); });
            document.getElementById('filter-kelas').addEventListener('change', function() {
                if (document.getElementById('filter-harian').classList.contains('hidden')) {
                    renderRekapAbsensi({ bulan: document.getElementById('filter-bulan').value });
                } else {
                    renderRekapAbsensi({ tanggal: document.getElementById('filter-tanggal').value });
                }
            });
            
            document.getElementById('pilih-kelas').addEventListener('change', loadOrClearAbsensi);
            
            document.getElementById('file-import').addEventListener('change', function(e) {
                document.getElementById('selected-file').textContent = this.files.length > 0 ? this.files[0].name : 'Belum ada file yang dipilih';
            });
            
            // FITUR BARU: Event listener untuk membatalkan pilihan radio button
            const daftarSiswaTbody = document.getElementById('daftar-siswa');
            daftarSiswaTbody.addEventListener('mousedown', function(e) {
                const target = e.target;
                if (target.tagName === 'INPUT' && target.type === 'radio' && target.checked) {
                    target.dataset.wasChecked = 'true';
                }
            });
            daftarSiswaTbody.addEventListener('click', function(e) {
                const target = e.target;
                if (target.tagName === 'INPUT' && target.type === 'radio' && target.dataset.wasChecked === 'true') {
                    target.checked = false;
                    target.dataset.wasChecked = 'false';
                } else if (target.tagName === 'INPUT' && target.type === 'radio') {
                    const radioGroup = document.getElementsByName(target.name);
                    radioGroup.forEach(radio => {
                        if (radio !== target) { radio.dataset.wasChecked = 'false'; }
                    });
                }
            });

             // FITUR BARU: Event listener untuk manajemen materi
            document.getElementById('tambah-materi').addEventListener('click', function() {
                if (!selectedKelasId) return;
                const input = document.getElementById('input-materi-baru');
                const materiBaru = input.value.trim();

                if (materiBaru) {
                    const kelas = kelasList.find(k => k.id === selectedKelasId);
                    if (kelas) {
                        if (!kelas.materi) kelas.materi = [];
                        if (kelas.materi.includes(materiBaru)) {
                            showNotification('Materi sudah ada!', 'error');
                            return;
                        }
                        kelas.materi.push(materiBaru);
                        
                        if (document.getElementById('kelas-budi-agung').classList.contains('bg-indigo-600')) {
                             localStorage.setItem('kelasBudiAgung', JSON.stringify(kelasBudiAgung));
                        } else {
                             localStorage.setItem('kelasSumbangsih', JSON.stringify(kelasSumbangsih));
                        }
                       
                        renderMateriList(selectedKelasId);
                        input.value = '';
                        showNotification('Materi berhasil ditambahkan!');
                    }
                }
            });
        });

        function switchSekolah(sekolah) {
            const btnBudiAgung = document.getElementById('sekolah-budi-agung');
            const btnSumbangsih = document.getElementById('sekolah-sumbangsih');
            const kelasBtnBudiAgung = document.getElementById('kelas-budi-agung');
            const kelasBtnSumbangsih = document.getElementById('kelas-sumbangsih');

            if (sekolah === 'Budi Agung') {
                document.getElementById('nama-sekolah').textContent = 'SMK Pariwisata Budi Agung';
                document.getElementById('rekap-sekolah').textContent = 'SMK Pariwisata Budi Agung';
                siswaList = [...siswaListBudiAgung];
                kelasList = [...kelasBudiAgung];
                btnBudiAgung.classList.add('bg-indigo-600', 'text-white');
                btnBudiAgung.classList.remove('bg-gray-200', 'text-gray-700');
                btnSumbangsih.classList.add('bg-gray-200', 'text-gray-700');
                btnSumbangsih.classList.remove('bg-indigo-600', 'text-white');
                kelasBtnBudiAgung.classList.add('bg-indigo-600', 'text-white');
                kelasBtnBudiAgung.classList.remove('bg-gray-200', 'text-gray-700');
                kelasBtnSumbangsih.classList.add('bg-gray-200', 'text-gray-700');
                kelasBtnSumbangsih.classList.remove('bg-indigo-600', 'text-white');
            } else {
                document.getElementById('nama-sekolah').textContent = 'SMK Pariwisata Sumbangsih';
                document.getElementById('rekap-sekolah').textContent = 'SMK Pariwisata Sumbangsih';
                siswaList = [...siswaListSumbangsih];
                kelasList = [...kelasSumbangsih];
                btnSumbangsih.classList.add('bg-indigo-600', 'text-white');
                btnSumbangsih.classList.remove('bg-gray-200', 'text-gray-700');
                btnBudiAgung.classList.add('bg-gray-200', 'text-gray-700');
                btnBudiAgung.classList.remove('bg-indigo-600', 'text-white');
                kelasBtnSumbangsih.classList.add('bg-indigo-600', 'text-white');
                kelasBtnSumbangsih.classList.remove('bg-gray-200', 'text-gray-700');
                kelasBtnBudiAgung.classList.add('bg-gray-200', 'text-gray-700');
                kelasBtnBudiAgung.classList.remove('bg-indigo-600', 'text-white');
            }

            populateKelasDropdown();
            loadOrClearAbsensi();
            document.getElementById('detail-kelas').classList.add('hidden');
            selectedKelasId = null;
            renderDaftarKelas();
        }

        document.getElementById('sekolah-budi-agung').addEventListener('click', () => switchSekolah('Budi Agung'));
        document.getElementById('sekolah-sumbangsih').addEventListener('click', () => switchSekolah('Sumbangsih'));
        document.getElementById('kelas-budi-agung').addEventListener('click', () => switchSekolah('Budi Agung'));
        document.getElementById('kelas-sumbangsih').addEventListener('click', () => switchSekolah('Sumbangsih'));

        // Tab switching
        document.getElementById('tab1-btn').addEventListener('click', function() {
            document.getElementById('tab1').classList.remove('hidden'); document.getElementById('tab2').classList.add('hidden'); document.getElementById('tab3').classList.add('hidden');
            this.classList.add('tab-active'); this.classList.remove('tab-inactive');
            document.getElementById('tab2-btn').classList.add('tab-inactive'); document.getElementById('tab2-btn').classList.remove('tab-active');
            document.getElementById('tab3-btn').classList.add('tab-inactive'); document.getElementById('tab3-btn').classList.remove('tab-active');
        });

        document.getElementById('tab2-btn').addEventListener('click', function() {
            document.getElementById('tab1').classList.add('hidden'); document.getElementById('tab2').classList.remove('hidden'); document.getElementById('tab3').classList.add('hidden');
            this.classList.add('tab-active'); this.classList.remove('tab-inactive');
            document.getElementById('tab1-btn').classList.add('tab-inactive'); document.getElementById('tab1-btn').classList.remove('tab-active');
            document.getElementById('tab3-btn').classList.add('tab-inactive'); document.getElementById('tab3-btn').classList.remove('tab-active');
            document.getElementById('rekap-sekolah').textContent = document.getElementById('nama-sekolah').textContent;
            renderRekapAbsensi({ tanggal: document.getElementById('filter-tanggal').value });
        });

        document.getElementById('tab3-btn').addEventListener('click', function() {
            document.getElementById('tab1').classList.add('hidden'); document.getElementById('tab2').classList.add('hidden'); document.getElementById('tab3').classList.remove('hidden');
            this.classList.add('tab-active'); this.classList.remove('tab-inactive');
            document.getElementById('tab1-btn').classList.add('tab-inactive'); document.getElementById('tab1-btn').classList.remove('tab-active');
            document.getElementById('tab2-btn').classList.add('tab-inactive'); document.getElementById('tab2-btn').classList.remove('tab-active');
            renderDaftarKelas();
        });
        
        document.getElementById('rekap-harian-btn').addEventListener('click', function() {
            this.classList.add('bg-indigo-600', 'text-white'); this.classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('rekap-bulanan-btn').classList.add('bg-gray-200', 'text-gray-700'); document.getElementById('rekap-bulanan-btn').classList.remove('bg-indigo-600', 'text-white');
            document.getElementById('filter-harian').classList.remove('hidden'); document.getElementById('filter-bulanan').classList.add('hidden');
            renderRekapAbsensi({ tanggal: document.getElementById('filter-tanggal').value });
        });

        document.getElementById('rekap-bulanan-btn').addEventListener('click', function() {
            this.classList.add('bg-indigo-600', 'text-white'); this.classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById('rekap-harian-btn').classList.add('bg-gray-200', 'text-gray-700'); document.getElementById('rekap-harian-btn').classList.remove('bg-indigo-600', 'text-white');
            document.getElementById('filter-harian').classList.add('hidden'); document.getElementById('filter-bulanan').classList.remove('hidden');
            renderRekapAbsensi({ bulan: document.getElementById('filter-bulan').value });
        });

        // Tombol Hadir Semua
        document.getElementById('hadir-semua').addEventListener('click', function() {
            const kelasId = document.getElementById('pilih-kelas').value;
            if (!kelasId) { alert("Pilih kelas terlebih dahulu!"); return; }
            const filteredSiswa = siswaList.filter(siswa => siswa.kelasId === parseInt(kelasId));
            filteredSiswa.forEach(siswa => { siswa.status = 'hadir'; });
            renderDaftarSiswa();
        });

        // CRUD Siswa
        document.getElementById('tambah-siswa').addEventListener('click', function() { populateKelasDropdown(); document.getElementById('modal-tambah-siswa').classList.remove('hidden'); });
        document.getElementById('tambah-siswa-kelas').addEventListener('click', function() { document.getElementById('new-kelas').value = selectedKelasId; document.getElementById('modal-tambah-siswa').classList.remove('hidden'); });
        document.getElementById('batal-tambah').addEventListener('click', function() { document.getElementById('modal-tambah-siswa').classList.add('hidden'); document.getElementById('new-nisn').value = ''; document.getElementById('new-nama').value = ''; document.getElementById('new-kelas').value = ''; });
        document.getElementById('simpan-tambah').addEventListener('click', function() {
            const nisn = document.getElementById('new-nisn').value.trim(); const nama = document.getElementById('new-nama').value.trim(); const kelasId = parseInt(document.getElementById('new-kelas').value) || null;
            if (!nisn || !nama || !kelasId) { alert('NISN, Nama, dan Kelas harus diisi!'); return; }
            const currentSiswaList = document.getElementById('nama-sekolah').textContent.includes('Budi Agung') ? siswaListBudiAgung : siswaListSumbangsih;
            if (currentSiswaList.some(siswa => siswa.nisn === nisn)) { alert('NISN sudah terdaftar!'); return; }
            const newId = siswaList.length > 0 ? Math.max(...[...siswaListBudiAgung, ...siswaListSumbangsih].map(s => s.id)) + 1 : 1;
            const newSiswa = { id: newId, nisn, nama, status: '', nilai: '', keterangan: '', kelasId };
            
            if (document.getElementById('nama-sekolah').textContent.includes('Budi Agung')) { siswaListBudiAgung.push(newSiswa); siswaList = [...siswaListBudiAgung]; } 
            else { siswaListSumbangsih.push(newSiswa); siswaList = [...siswaListSumbangsih]; }
            
            localStorage.setItem('siswaListBudiAgung', JSON.stringify(siswaListBudiAgung)); localStorage.setItem('siswaListSumbangsih', JSON.stringify(siswaListSumbangsih));
            renderDaftarSiswa(); if (selectedKelasId) renderSiswaDalamKelas(selectedKelasId);
            document.getElementById('modal-tambah-siswa').classList.add('hidden'); document.getElementById('new-nisn').value = ''; document.getElementById('new-nama').value = ''; document.getElementById('new-kelas').value = '';
            showNotification('Siswa baru berhasil ditambahkan!');
        });
        document.getElementById('batal-edit').addEventListener('click', function() { document.getElementById('modal-edit-siswa').classList.add('hidden'); });
        document.getElementById('simpan-edit').addEventListener('click', function() {
            const id = parseInt(document.getElementById('edit-siswa-id').value); const nisn = document.getElementById('edit-nisn').value.trim(); const nama = document.getElementById('edit-nama').value.trim(); const kelasId = parseInt(document.getElementById('edit-kelas-select').value) || null;
            if (!nisn || !nama || !kelasId) { alert('NISN, Nama, dan Kelas harus diisi!'); return; }
            const currentSiswaList = document.getElementById('nama-sekolah').textContent.includes('Budi Agung') ? siswaListBudiAgung : siswaListSumbangsih;
            if (currentSiswaList.some(siswa => siswa.nisn === nisn && siswa.id !== id)) { alert('NISN sudah terdaftar!'); return; }
            
            const isBudiAgung = siswaListBudiAgung.some(s => s.id === id);
            const isSumbangsih = siswaListSumbangsih.some(s => s.id === id);
            
            let siswa;
            if(isBudiAgung) siswa = siswaListBudiAgung.find(s => s.id === id);
            if(isSumbangsih) siswa = siswaListSumbangsih.find(s => s.id === id);

            if (siswa) { siswa.nisn = nisn; siswa.nama = nama; siswa.kelasId = kelasId; }

            localStorage.setItem('siswaListBudiAgung', JSON.stringify(siswaListBudiAgung)); localStorage.setItem('siswaListSumbangsih', JSON.stringify(siswaListSumbangsih));
            
            switchSekolah(document.getElementById('nama-sekolah').textContent.includes('Budi Agung') ? 'Budi Agung' : 'Sumbangsih');

            document.getElementById('modal-edit-siswa').classList.add('hidden');
            showNotification('Data siswa berhasil diperbarui!');
        });

        // CRUD Kelas
        document.getElementById('tambah-kelas').addEventListener('click', function() { document.getElementById('modal-tambah-kelas').classList.remove('hidden'); });
        document.getElementById('batal-tambah-kelas').addEventListener('click', function() { document.getElementById('modal-tambah-kelas').classList.add('hidden'); document.getElementById('new-nama-kelas').value = ''; document.getElementById('new-wali-kelas').value = ''; });
        document.getElementById('simpan-tambah-kelas').addEventListener('click', function() {
            const namaKelas = document.getElementById('new-nama-kelas').value.trim(); const waliKelas = document.getElementById('new-wali-kelas').value.trim();
            if (!namaKelas || !waliKelas) { alert('Nama Kelas dan Wali Kelas harus diisi!'); return; }
            if (kelasList.some(kelas => kelas.nama === namaKelas)) { alert('Nama Kelas sudah terdaftar!'); return; }
            const newId = kelasList.length > 0 ? Math.max(...[...kelasBudiAgung, ...kelasSumbangsih].map(k => k.id)) + 1 : 1;
            const newKelas = { id: newId, nama: namaKelas, waliKelas: waliKelas, materi: [] };
            
            if (document.getElementById('kelas-budi-agung').classList.contains('bg-indigo-600')) { kelasBudiAgung.push(newKelas); kelasList = [...kelasBudiAgung]; localStorage.setItem('kelasBudiAgung', JSON.stringify(kelasBudiAgung)); }
             else { kelasSumbangsih.push(newKelas); kelasList = [...kelasSumbangsih]; localStorage.setItem('kelasSumbangsih', JSON.stringify(kelasSumbangsih)); }

            populateKelasDropdown(); renderDaftarKelas();
            document.getElementById('modal-tambah-kelas').classList.add('hidden'); document.getElementById('new-nama-kelas').value = ''; document.getElementById('new-wali-kelas').value = '';
            showNotification('Kelas baru berhasil ditambahkan!');
        });
        document.getElementById('edit-kelas').addEventListener('click', function() {
            if (!selectedKelasId) return; const kelas = kelasList.find(k => k.id === selectedKelasId);
            if (kelas) {
                document.getElementById('edit-kelas-id').value = kelas.id; document.getElementById('edit-nama-kelas').value = kelas.nama; document.getElementById('edit-wali-kelas').value = kelas.waliKelas;
                document.getElementById('modal-edit-kelas').classList.remove('hidden');
            }
        });
        document.getElementById('batal-edit-kelas').addEventListener('click', function() { document.getElementById('modal-edit-kelas').classList.add('hidden'); });
        document.getElementById('simpan-edit-kelas').addEventListener('click', function() {
            const id = parseInt(document.getElementById('edit-kelas-id').value); const namaKelas = document.getElementById('edit-nama-kelas').value.trim(); const waliKelas = document.getElementById('edit-wali-kelas').value.trim();
            if (!namaKelas || !waliKelas) { alert('Nama Kelas dan Wali Kelas harus diisi!'); return; }
            if (kelasList.some(kelas => kelas.nama === namaKelas && kelas.id !== id)) { alert('Nama Kelas sudah terdaftar!'); return; }
            const kelas = kelasList.find(k => k.id === id);
            if (kelas) { kelas.nama = namaKelas; kelas.waliKelas = waliKelas; }
            
            if (document.getElementById('kelas-budi-agung').classList.contains('bg-indigo-600')) { localStorage.setItem('kelasBudiAgung', JSON.stringify(kelasBudiAgung)); } 
            else { localStorage.setItem('kelasSumbangsih', JSON.stringify(kelasSumbangsih)); }
            
            populateKelasDropdown(); renderDaftarKelas(); document.getElementById('nama-kelas-detail').textContent = namaKelas;
            document.getElementById('modal-edit-kelas').classList.add('hidden');
            showNotification('Data kelas berhasil diperbarui!');
        });
        document.getElementById('hapus-kelas').addEventListener('click', function() {
            if (!selectedKelasId) return;
            if (confirm('Apakah Anda yakin ingin menghapus kelas ini? Semua siswa dalam kelas ini juga akan terhapus.')) {
                if (document.getElementById('kelas-budi-agung').classList.contains('bg-indigo-600')) {
                    kelasBudiAgung = kelasBudiAgung.filter(kelas => kelas.id !== selectedKelasId);
                    siswaListBudiAgung = siswaListBudiAgung.filter(siswa => siswa.kelasId !== selectedKelasId);
                    kelasList = [...kelasBudiAgung]; siswaList = [...siswaListBudiAgung];
                    localStorage.setItem('kelasBudiAgung', JSON.stringify(kelasBudiAgung)); localStorage.setItem('siswaListBudiAgung', JSON.stringify(siswaListBudiAgung));
                } else {
                    kelasSumbangsih = kelasSumbangsih.filter(kelas => kelas.id !== selectedKelasId);
                    siswaListSumbangsih = siswaListSumbangsih.filter(siswa => siswa.kelasId !== selectedKelasId);
                    kelasList = [...kelasSumbangsih]; siswaList = [...siswaListSumbangsih];
                    localStorage.setItem('kelasSumbangsih', JSON.stringify(kelasSumbangsih)); localStorage.setItem('siswaListSumbangsih', JSON.stringify(siswaListSumbangsih));
                }
                populateKelasDropdown(); renderDaftarKelas(); document.getElementById('detail-kelas').classList.add('hidden');
                selectedKelasId = null;
                showNotification('Kelas dan siswa di dalamnya berhasil dihapus!');
            }
        });

        // PERUBAHAN: Simpan absen sekarang menyertakan materi
        document.getElementById('simpan-absen').addEventListener('click', function() {
            const tanggal = document.getElementById('tanggal').value; const namaSekolah = document.getElementById('nama-sekolah').textContent; const namaGuru = document.getElementById('nama-guru').textContent; const mataPelajaran = document.getElementById('mata-pelajaran').textContent; const kelasId = parseInt(document.getElementById('pilih-kelas').value) || null;
            const materi = document.getElementById('pilih-materi').value; // Ambil materi yang dipilih
            
            if (!tanggal || !kelasId) { alert('Tanggal dan Kelas harus dipilih!'); return; }
            if (!materi) { alert('Materi pembahasan harus dipilih!'); return;}

            const namaKelas = kelasList.find(k => k.id === kelasId)?.nama || 'Tidak Diketahui';
            const filteredSiswa = siswaList.filter(siswa => siswa.kelasId === kelasId);
            
            filteredSiswa.forEach(siswa => {
                const statusRadios = document.getElementsByName(`status-${siswa.id}`); let selectedStatus = '';
                for (const radio of statusRadios) { if (radio.checked) { selectedStatus = radio.value; break; } }
                siswa.status = selectedStatus;
                siswa.nilai = document.querySelector(`.nilai-${siswa.id}`).value;
                siswa.keterangan = document.querySelector(`.keterangan-${siswa.id}`).value;
            });
            
            const belumDiisi = filteredSiswa.filter(siswa => !siswa.status);
            if (belumDiisi.length > 0) {
                if (!confirm(`Ada ${belumDiisi.length} siswa yang belum diisi status kehadirannya. Lanjutkan menyimpan?`)) { return; }
            }
            
            const existingIndex = absensiData.findIndex(data => data.tanggal === tanggal && data.namaSekolah === namaSekolah && data.kelasId === kelasId);
            const dataToSave = { tanggal, namaSekolah, namaGuru, mataPelajaran, kelasId, kelas: namaKelas, materi, siswa: JSON.parse(JSON.stringify(filteredSiswa)) };
            
            if (existingIndex !== -1) { absensiData[existingIndex] = dataToSave; } else { absensiData.push(dataToSave); }
            
            localStorage.setItem('absensiData', JSON.stringify(absensiData));
            showNotification('Absen berhasil disimpan!');
        });
        
        // Export dan Cetak (tidak ada perubahan signifikan)
        document.getElementById('ekspor-excel').addEventListener('click', function() {
            const tanggal = document.getElementById('tanggal').value; const namaSekolah = document.getElementById('nama-sekolah').textContent; const namaGuru = document.getElementById('nama-guru').textContent; const mataPelajaran = document.getElementById('mata-pelajaran').textContent; const kelasId = parseInt(document.getElementById('pilih-kelas').value) || null;
            const materi = document.getElementById('pilih-materi').value;
            if (!kelasId) { alert('Pilih kelas terlebih dahulu untuk ekspor!'); return; }
            const namaKelas = kelasList.find(k => k.id === kelasId)?.nama || 'Tidak Diketahui';
            const filteredSiswa = siswaList.filter(siswa => siswa.kelasId === kelasId);
            const data = [
                ['Absensi Siswa'], ['Sekolah:', namaSekolah], ['Guru:', namaGuru], ['Mata Pelajaran:', mataPelajaran], ['Kelas:', namaKelas], ['Tanggal:', tanggal], ['Materi:', materi],
                [], ['No', 'NISN', 'Nama', 'Hadir', 'Izin', 'Sakit', 'Absen', 'Nilai', 'Keterangan']
            ];
            filteredSiswa.forEach((siswa, index) => {
                data.push([
                    index + 1, siswa.nisn, siswa.nama,
                    siswa.status === 'hadir' ? '✓' : '', siswa.status === 'izin' ? '✓' : '', siswa.status === 'sakit' ? '✓' : '', siswa.status === 'absen' ? '✓' : '',
                    siswa.nilai || '', siswa.keterangan || ''
                ]);
            });
            const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Absensi');
            const sekolahSingkat = namaSekolah.includes('Budi Agung') ? 'BA' : 'SB';
            const kelasText = namaKelas.replace(/\s+/g, '_');
            XLSX.writeFile(wb, `Absensi_${sekolahSingkat}_${kelasText}_${tanggal}.xlsx`);
        });
        document.getElementById('ekspor-rekap').addEventListener('click', function() {
            const namaSekolah = document.getElementById('rekap-sekolah').textContent; const kelasId = document.getElementById('filter-kelas').value; const mataPelajaran = document.getElementById('rekap-mapel').textContent;
            let namaKelas = 'Semua Kelas'; if (kelasId) { const kelas = kelasList.find(k => k.id === parseInt(kelasId)); if (kelas) namaKelas = kelas.nama; }
            let title, filterValue;
            if (document.getElementById('filter-harian').classList.contains('hidden')) { filterValue = document.getElementById('filter-bulan').value; title = `Rekap Bulanan - ${filterValue}`; }
            else { filterValue = document.getElementById('filter-tanggal').value; title = `Rekap Harian - ${filterValue}`; }
            const data = [
                [title], ['Sekolah:', namaSekolah], ['Kelas:', namaKelas], ['Mata Pelajaran:', mataPelajaran], [],
                ['No', 'NISN', 'Nama', 'Hadir', 'Izin', 'Sakit', 'Absen', 'Nilai Rata-rata', 'Keterangan']
            ];
            const rows = document.getElementById('rekap-siswa').querySelectorAll('tr');
            rows.forEach(row => { const cells = row.querySelectorAll('td'); if (cells.length > 1) { data.push(Array.from(cells).map(cell => cell.textContent)); } });
            data.push([]); data.push(['Statistik:']); data.push(['Total Hadir:', document.getElementById('total-hadir').textContent]); data.push(['Total Izin:', document.getElementById('total-izin').textContent]); data.push(['Total Sakit:', document.getElementById('total-sakit').textContent]); data.push(['Total Absen:', document.getElementById('total-absen').textContent]); data.push(['Nilai Rata-rata:', document.getElementById('total-nilai').textContent]);
            const ws = XLSX.utils.aoa_to_sheet(data); const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Rekap Absensi');
            const sekolahSingkat = namaSekolah.includes('Budi Agung') ? 'BA' : 'SB'; const kelasText = namaKelas.replace(/\s+/g, '_');
            XLSX.writeFile(wb, `Rekap_Absensi_${sekolahSingkat}_${kelasText}_${filterValue}.xlsx`);
        });
        document.getElementById('cetak-rekap').addEventListener('click', function() { window.print(); });

        // Import
        document.getElementById('import-siswa').addEventListener('click', function() { document.getElementById('file-import').value = ''; document.getElementById('selected-file').textContent = 'Belum ada file yang dipilih'; document.getElementById('modal-import-siswa').classList.remove('hidden'); });
        document.getElementById('batal-import').addEventListener('click', function() { document.getElementById('modal-import-siswa').classList.add('hidden'); });
        document.getElementById('proses-import').addEventListener('click', function() {
            const fileInput = document.getElementById('file-import'); if (!fileInput.files || fileInput.files.length === 0) { alert('Pilih file terlebih dahulu!'); return; }
            const file = fileInput.files[0];
            readExcelFile(file).then(data => {
                if (data.length === 0) { alert('File tidak berisi data siswa.'); return; }
                importData = data;
                const previewData = document.getElementById('preview-data'); previewData.innerHTML = '';
                const kelas = kelasList.find(k => k.id === selectedKelasId); document.getElementById('preview-nama-kelas').textContent = kelas ? kelas.nama : '';
                const currentSiswaList = document.getElementById('kelas-budi-agung').classList.contains('bg-indigo-600') ? siswaListBudiAgung : siswaListSumbangsih;
                const existingNISNs = currentSiswaList.map(s => s.nisn);
                data.forEach((siswa, index) => {
                    const row = document.createElement('tr'); row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                    const isDuplicate = existingNISNs.includes(siswa.nisn);
                    row.innerHTML = `<td class="py-3 px-4">${index + 1}</td><td class="py-3 px-4">${siswa.nisn}</td><td class="py-3 px-4">${siswa.nama}</td><td class="py-3 px-4 text-center">${isDuplicate ? '<span class="text-red-500 font-medium">NISN sudah ada</span>' : '<span class="text-green-500 font-medium">Baru</span>'}</td>`;
                    previewData.appendChild(row);
                });
                document.getElementById('modal-import-siswa').classList.add('hidden'); document.getElementById('modal-preview-import').classList.remove('hidden');
            }).catch(error => { alert(error); });
        });
        document.getElementById('batal-preview').addEventListener('click', function() { document.getElementById('modal-preview-import').classList.add('hidden'); });
        document.getElementById('konfirmasi-import').addEventListener('click', function() {
            if (!selectedKelasId || importData.length === 0) { alert('Tidak ada data yang dapat diimport.'); return; }
            
            const isBudiAgung = document.getElementById('kelas-budi-agung').classList.contains('bg-indigo-600');
            const targetSiswaList = isBudiAgung ? siswaListBudiAgung : siswaListSumbangsih;
            const existingNISNs = targetSiswaList.map(s => s.nisn);
            let lastId = [...siswaListBudiAgung, ...siswaListSumbangsih].length > 0 ? Math.max(...[...siswaListBudiAgung, ...siswaListSumbangsih].map(s => s.id)) : 0;
            let addedCount = 0; let duplicateCount = 0;
            
            importData.forEach(siswa => {
                if (!existingNISNs.includes(siswa.nisn)) {
                    lastId++;
                    targetSiswaList.push({ id: lastId, nisn: siswa.nisn, nama: siswa.nama, status: '', nilai: '', keterangan: '', kelasId: selectedKelasId });
                    addedCount++;
                } else { duplicateCount++; }
            });
            
            if (isBudiAgung) { localStorage.setItem('siswaListBudiAgung', JSON.stringify(siswaListBudiAgung)); siswaList = [...siswaListBudiAgung]; } 
            else { localStorage.setItem('siswaListSumbangsih', JSON.stringify(siswaListSumbangsih)); siswaList = [...siswaListSumbangsih]; }
            
            renderSiswaDalamKelas(selectedKelasId);
            document.getElementById('modal-preview-import').classList.add('hidden');
            showNotification(`${addedCount} siswa berhasil ditambahkan. ${duplicateCount} siswa diabaikan karena NISN duplikat.`);
        });
        document.getElementById('export-template').addEventListener('click', function() { createExcelTemplate(); });
    </script>
</body>
</html>
