<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Absensi Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background-color: #f0f4f8;
        }
        .tab-active { background-color: #4f46e5; color: white; }
        .tab-inactive { background-color: #e5e7eb; color: #4b5563; }
        .notification {
            transform: translateY(-120px);
            transition: transform 0.5s ease-in-out;
            opacity: 0;
        }
        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }
        @media print {
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="notification fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50" id="notification"></div>

    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="flex no-print">
                <button id="tab1-btn" class="tab-active flex-1 py-4 font-medium text-center transition-all">Absensi Harian</button>
                <button id="tab2-btn" class="tab-inactive flex-1 py-4 font-medium text-center transition-all">Rekap Absensi</button>
                <button id="tab3-btn" class="tab-inactive flex-1 py-4 font-medium text-center transition-all">Manajemen</button>
            </div>

            <div id="tab1" class="p-6">
                <div class="mb-8 text-center">
                    <div class="mb-4">
                        <h2 class="text-lg font-medium text-indigo-700 mb-2">Pilih Sekolah</h2>
                        <div class="flex justify-center gap-4">
                            <button id="sekolah-budi-agung" class="bg-indigo-600 text-white px-4 py-2 rounded-lg">SMK Pariwisata Budi Agung</button>
                            <button id="sekolah-sumbangsih" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg">SMK Pariwisata Sumbangsih</button>
                        </div>
                    </div>
                    <h1 class="text-3xl font-bold text-indigo-700" id="nama-sekolah"></h1>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Guru</h2>
                            <p class="mt-1" id="nama-guru">MOHAMAD AL-IMRON, S.KOM</p>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Mata Pelajaran</h2>
                            <p class="mt-1" id="mata-pelajaran">Simulasi Digital dan Komunikasi</p>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Kelas</h2>
                            <select id="pilih-kelas" class="mt-1 w-full p-2 border border-indigo-200 rounded-md"></select>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Materi Pembelajaran</h2>
                            <select id="pilih-materi" class="mt-1 w-full p-2 border border-indigo-200 rounded-md"></select>
                        </div>
                        <div class="bg-indigo-50 p-4 rounded-lg">
                            <h2 class="text-lg font-medium text-indigo-700">Tanggal</h2>
                            <input type="date" id="tanggal" class="mt-1 w-full p-2 border border-indigo-200 rounded-md">
                        </div>
                    </div>
                </div>
                <div class="flex flex-wrap gap-3 mb-6">
                    <button id="hadir-semua" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-all">Hadir Semua</button>
                    <button id="tambah-siswa" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-all">Tambah Siswa</button>
                    <button id="ekspor-excel" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg transition-all">Ekspor ke Excel</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white border border-gray-200 rounded-lg overflow-hidden">
                        <thead class="bg-indigo-600 text-white">
                            <tr>
                                <th class="py-3 px-4 text-left">No</th>
                                <th class="py-3 px-4 text-left">NISN</th>
                                <th class="py-3 px-4 text-left">Nama</th>
                                <th class="py-3 px-4 text-center">Hadir</th>
                                <th class="py-3 px-4 text-center">Izin</th>
                                <th class="py-3 px-4 text-center">Sakit</th>
                                <th class="py-3 px-4 text-center">Absen</th>
                                <th class="py-3 px-4 text-center">Nilai</th>
                                <th class="py-3 px-4 text-left">Materi</th>
                                <th class="py-3 px-4 text-center">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="daftar-siswa"></tbody>
                    </table>
                </div>
                <div class="mt-6 flex justify-end">
                    <button id="simpan-absen" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition-all shadow-lg text-lg font-medium">Simpan Absensi</button>
                </div>
            </div>

            <div id="tab2" class="p-6 hidden">
                </div>

            <div id="tab3" class="p-6 hidden">
                <div class="mb-6 flex flex-wrap justify-between items-center">
                    <h2 class="text-2xl font-bold text-indigo-700">Manajemen Kelas</h2>
                    <button id="tambah-kelas" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Tambah Kelas Baru</button>
                </div>
                <div id="detail-kelas" class="hidden mt-6 border-t pt-6">
                    <h3 class="text-xl font-medium text-indigo-700">Detail Kelas: <span id="nama-kelas-detail"></span></h3>
                    <div class="mt-4">
                        <h4 class="text-lg font-medium text-indigo-700 mb-2">Manajemen Siswa</h4>
                         <button id="tambah-siswa-kelas" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-lg">Tambah Siswa</button>
                         </div>
                     <div class="mt-6">
                        <h4 class="text-lg font-medium text-indigo-700 mb-2">Manajemen Materi</h4>
                        <button id="tambah-materi-kelas" class="bg-purple-500 hover:bg-purple-600 text-white px-4 py-2 rounded-lg">Tambah Materi</button>
                        <div id="daftar-materi-kelas" class="mt-4 space-y-2"></div>
                    </div>
                </div>
                 <div id="daftar-kelas-container" class="mt-6"></div>
            </div>
        </div>
    </div>

    <div id="modal-tambah-siswa" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Tambah Siswa Baru</h2>
            <div class="space-y-4">
                <div><label class="block">NISN</label><input type="text" id="new-nisn" class="w-full p-2 border rounded"></div>
                <div><label class="block">Nama</label><input type="text" id="new-nama" class="w-full p-2 border rounded"></div>
                <div><label class="block">Kelas</label><select id="new-kelas" class="w-full p-2 border rounded"></select></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="batal-tambah" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Batal</button>
                <button id="simpan-tambah" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>
    <div id="modal-tambah-kelas" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Tambah Kelas Baru</h2>
            <div class="space-y-4">
                 <div><label class="block">Nama Kelas</label><input type="text" id="new-nama-kelas" class="w-full p-2 border rounded"></div>
                 <div><label class="block">Wali Kelas</label><input type="text" id="new-wali-kelas" class="w-full p-2 border rounded"></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="batal-tambah-kelas" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Batal</button>
                <button id="simpan-tambah-kelas" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>
     <div id="modal-tambah-materi" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4">Tambah Materi Baru</h2>
            <div><label class="block">Nama Materi</label><input type="text" id="new-nama-materi" class="w-full p-2 border rounded"></div>
            <div class="flex justify-end gap-2 mt-6">
                <button id="batal-tambah-materi" class="bg-gray-300 hover:bg-gray-400 px-4 py-2 rounded-lg">Batal</button>
                <button id="simpan-tambah-materi" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg">Simpan</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    let state = {
        sekolahAktif: 'Budi Agung',
        absensiData: [],
        sekolah: {
            "Budi Agung": {
                kelas: [
                    { id: 1, nama: "X RPL 1", waliKelas: "Budi Santoso", materi: ["Pengenalan HTML", "Dasar CSS"] },
                    { id: 2, nama: "X RPL 2", waliKelas: "Siti Aminah", materi: ["Variabel & Tipe Data", "Struktur Kontrol"] }
                ],
                siswa: [
                    { id: 1, nisn: "0001", nama: "Yuli", kelasId: 1 },
                    { id: 2, nisn: "0002", nama: "Risma", kelasId: 1 },
                    { id: 3, nisn: "0003", nama: "Doni", kelasId: 2 },
                    { id: 4, nisn: "0004", nama: "Rina", kelasId: 2 }
                ]
            },
            "Sumbangsih": {
                kelas: [
                    { id: 3, nama: "X TKJ 1", waliKelas: "Ahmad Fauzi", materi: ["Jaringan Dasar"] },
                    { id: 4, nama: "X TKJ 2", waliKelas: "Dewi Lestari", materi: ["Perakitan PC"] }
                ],
                siswa: [
                    { id: 5, nisn: "1001", nama: "Ahmad", kelasId: 3 },
                    { id: 6, nisn: "1002", nama: "Budi", kelasId: 3 }
                ]
            }
        },
        selectedKelasId: null,
        selectedKelasIdManajemen: null
    };

    const loadState = () => {
        const savedState = localStorage.getItem('absensiAppState');
        if (savedState) {
            Object.assign(state, JSON.parse(savedState));
        }
    };

    const saveState = () => {
        localStorage.setItem('absensiAppState', JSON.stringify(state));
    };

    // --- DOM ELEMENTS ---
    const getEl = (id) => document.getElementById(id);
    const elements = {
        notification: getEl('notification'),
        tab1Btn: getEl('tab1-btn'),
        tab2Btn: getEl('tab2-btn'),
        tab3Btn: getEl('tab3-btn'),
        tab1: getEl('tab1'),
        tab2: getEl('tab2'),
        tab3: getEl('tab3'),
        sekolahBudiAgungBtn: getEl('sekolah-budi-agung'),
        sekolahSumbangsihBtn: getEl('sekolah-sumbangsih'),
        namaSekolahEl: getEl('nama-sekolah'),
        pilihKelasEl: getEl('pilih-kelas'),
        pilihMateriEl: getEl('pilih-materi'),
        tanggalEl: getEl('tanggal'),
        daftarSiswaEl: getEl('daftar-siswa'),
        simpanAbsenBtn: getEl('simpan-absen'),
        tambahKelasBtn: getEl('tambah-kelas'),
        detailKelasEl: getEl('detail-kelas'),
        namaKelasDetailEl: getEl('nama-kelas-detail'),
        daftarMateriKelasEl: getEl('daftar-materi-kelas'),
        tambahMateriBtn: getEl('tambah-materi-kelas'),
        daftarKelasContainer: getEl('daftar-kelas-container'),
        tambahSiswaBtn: getEl('tambah-siswa-kelas'),
        modalTambahMateri: getEl('modal-tambah-materi'),
        batalTambahMateriBtn: getEl('batal-tambah-materi'),
        simpanTambahMateriBtn: getEl('simpan-tambah-materi'),
        newNamaMateriEl: getEl('new-nama-materi'),
    };

    // --- RENDER FUNCTIONS ---
    const showNotification = (message, isError = false) => {
        elements.notification.textContent = message;
        elements.notification.className = `notification fixed top-4 right-4 text-white px-6 py-3 rounded-lg shadow-lg z-50 show ${isError ? 'bg-red-500' : 'bg-green-500'}`;
        setTimeout(() => elements.notification.classList.remove('show'), 3000);
    };

    const renderDaftarSiswa = () => {
        const kelasId = parseInt(elements.pilihKelasEl.value);
        elements.daftarSiswaEl.innerHTML = '';
        if (!kelasId) {
            elements.daftarSiswaEl.innerHTML = `<tr><td colspan="10" class="text-center py-4">Pilih kelas terlebih dahulu.</td></tr>`;
            return;
        }

        const siswaDiKelas = state.sekolah[state.sekolahAktif].siswa.filter(s => s.kelasId === kelasId);
        const tanggal = elements.tanggalEl.value;
        const absensiHariIni = state.absensiData.find(a => a.tanggal === tanggal && a.kelasId === kelasId);

        if (siswaDiKelas.length === 0) {
            elements.daftarSiswaEl.innerHTML = `<tr><td colspan="10" class="text-center py-4">Tidak ada siswa di kelas ini.</td></tr>`;
            return;
        }

        siswaDiKelas.forEach((siswa, index) => {
            const dataAbsenSiswa = absensiHariIni?.siswa.find(s => s.id === siswa.id) || {};
            const row = document.createElement('tr');
            row.className = index % 2 === 0 ? 'bg-gray-50' : 'bg-white';
            row.innerHTML = `
                <td class="py-3 px-4">${index + 1}</td>
                <td class="py-3 px-4">${siswa.nisn}</td>
                <td class="py-3 px-4">${siswa.nama}</td>
                ${['hadir', 'izin', 'sakit', 'absen'].map(status => `
                    <td class="py-3 px-4 text-center">
                        <input type="radio" name="status-${siswa.id}" value="${status}" ${dataAbsenSiswa.status === status ? 'checked' : ''}>
                    </td>
                `).join('')}
                <td class="py-3 px-4"><input type="number" class="nilai-input w-full p-1 border rounded" value="${dataAbsenSiswa.nilai || ''}" data-id="${siswa.id}"></td>
                <td class="py-3 px-4"><input type="text" class="materi-input w-full p-1 border rounded" value="${dataAbsenSiswa.materi || ''}" data-id="${siswa.id}"></td>
                <td class="py-3 px-4 text-center"></td>
            `;
            elements.daftarSiswaEl.appendChild(row);
        });
    };

    const populateDropdowns = () => {
        const kelasAktif = state.sekolah[state.sekolahAktif].kelas;
        elements.pilihKelasEl.innerHTML = '<option value="">Pilih Kelas</option>';
        kelasAktif.forEach(k => elements.pilihKelasEl.innerHTML += `<option value="${k.id}">${k.nama}</option>`);
    };

    const updateMateriDropdown = () => {
        const kelasId = parseInt(elements.pilihKelasEl.value);
        elements.pilihMateriEl.innerHTML = '<option value="">Pilih Materi Otomatis</option>';
        if (!kelasId) return;

        const kelas = state.sekolah[state.sekolahAktif].kelas.find(k => k.id === kelasId);
        if (kelas && kelas.materi) {
            kelas.materi.forEach(m => elements.pilihMateriEl.innerHTML += `<option value="${m}">${m}</option>`);
        }
    };
    
    const renderManajemenKelas = () => {
        elements.daftarKelasContainer.innerHTML = '';
        state.sekolah[state.sekolahAktif].kelas.forEach(kelas => {
            const card = document.createElement('div');
            card.className = 'p-4 border rounded cursor-pointer hover:bg-indigo-50';
            card.textContent = kelas.nama;
            card.dataset.id = kelas.id;
            card.addEventListener('click', () => {
                state.selectedKelasIdManajemen = kelas.id;
                elements.namaKelasDetailEl.textContent = kelas.nama;
                elements.detailKelasEl.classList.remove('hidden');
                renderDaftarMateri();
            });
            elements.daftarKelasContainer.appendChild(card);
        });
    };

    const renderDaftarMateri = () => {
        elements.daftarMateriKelasEl.innerHTML = '';
        const kelas = state.sekolah[state.sekolahAktif].kelas.find(k => k.id === state.selectedKelasIdManajemen);
        if (!kelas || !kelas.materi) return;
        
        kelas.materi.forEach(materi => {
            const item = document.createElement('div');
            item.className = 'flex justify-between items-center p-2 bg-gray-100 rounded';
            item.innerHTML = `<span>${materi}</span><button class="text-red-500 font-bold" data-materi="${materi}">&times;</button>`;
            item.querySelector('button').addEventListener('click', (e) => {
                const materiToRemove = e.target.dataset.materi;
                kelas.materi = kelas.materi.filter(m => m !== materiToRemove);
                saveState();
                renderDaftarMateri();
                showNotification('Materi dihapus.');
            });
            elements.daftarMateriKelasEl.appendChild(item);
        });
    };

    // --- EVENT HANDLERS ---
    const handleSwitchTab = (tabName) => {
        ['tab1', 'tab2', 'tab3'].forEach(tab => {
            elements[tab].classList.toggle('hidden', tab !== tabName);
            elements[`${tab}Btn`].classList.toggle('tab-active', tab === tabName);
            elements[`${tab}Btn`].classList.toggle('tab-inactive', tab !== tabName);
        });
        if (tabName === 'tab3') renderManajemenKelas();
    };

    const handleSwitchSekolah = (namaSekolah) => {
        state.sekolahAktif = namaSekolah;
        elements.namaSekolahEl.textContent = `SMK Pariwisata ${namaSekolah}`;
        elements.sekolahBudiAgungBtn.classList.toggle('bg-indigo-600', namaSekolah === 'Budi Agung');
        elements.sekolahSumbangsihBtn.classList.toggle('bg-indigo-600', namaSekolah === 'Sumbangsih');
        elements.sekolahBudiAgungBtn.classList.toggle('bg-gray-200', namaSekolah !== 'Budi Agung');
        elements.sekolahSumbangsihBtn.classList.toggle('bg-gray-200', namaSekolah !== 'Sumbangsih');
        populateDropdowns();
        renderDaftarSiswa();
        updateMateriDropdown();
    };

    const handleKelasChange = () => {
        state.selectedKelasId = parseInt(elements.pilihKelasEl.value) || null;
        renderDaftarSiswa();
        updateMateriDropdown();
    };

    const handleMateriChange = (e) => {
        const materiTerpilih = e.target.value;
        if (!materiTerpilih) return;
        document.querySelectorAll('.materi-input').forEach(input => input.value = materiTerpilih);
    };

    const handleSimpanAbsen = () => {
        const tanggal = elements.tanggalEl.value;
        const kelasId = parseInt(elements.pilihKelasEl.value);
        if (!tanggal || !kelasId) {
            showNotification('Tanggal dan Kelas harus dipilih!', true);
            return;
        }

        const absensiHariIni = {
            tanggal,
            kelasId,
            sekolah: state.sekolahAktif,
            siswa: []
        };
        
        const rows = elements.daftarSiswaEl.querySelectorAll('tr');
        rows.forEach(row => {
            const radio = row.querySelector('input[type="radio"]:checked');
            if (!radio) return;
            const id = parseInt(radio.name.split('-')[1]);
            absensiHariIni.siswa.push({
                id,
                status: radio.value,
                nilai: row.querySelector('.nilai-input').value,
                materi: row.querySelector('.materi-input').value,
            });
        });

        const existingIndex = state.absensiData.findIndex(a => a.tanggal === tanggal && a.kelasId === kelasId);
        if (existingIndex > -1) state.absensiData[existingIndex] = absensiHariIni;
        else state.absensiData.push(absensiHariIni);
        
        saveState();
        showNotification('Absensi berhasil disimpan.');
    };
    
    const handleSimpanMateri = () => {
        const namaMateri = elements.newNamaMateriEl.value.trim();
        if (!namaMateri) return;
        
        const kelas = state.sekolah[state.sekolahAktif].kelas.find(k => k.id === state.selectedKelasIdManajemen);
        if(kelas){
            if (!kelas.materi) kelas.materi = [];
            kelas.materi.push(namaMateri);
            saveState();
            renderDaftarMateri();
            elements.modalTambahMateri.classList.add('hidden');
            elements.newNamaMateriEl.value = '';
            showNotification('Materi berhasil ditambahkan.');
        }
    };

    // --- INITIALIZATION & EVENT BINDING ---
    loadState();
    elements.tanggalEl.value = new Date().toISOString().split('T')[0];
    handleSwitchSekolah(state.sekolahAktif);
    
    elements.tab1Btn.addEventListener('click', () => handleSwitchTab('tab1'));
    elements.tab2Btn.addEventListener('click', () => handleSwitchTab('tab2'));
    elements.tab3Btn.addEventListener('click', () => handleSwitchTab('tab3'));
    elements.sekolahBudiAgungBtn.addEventListener('click', () => handleSwitchSekolah('Budi Agung'));
    elements.sekolahSumbangsihBtn.addEventListener('click', () => handleSwitchSekolah('Sumbangsih'));
    elements.pilihKelasEl.addEventListener('change', handleKelasChange);
    elements.pilihMateriEl.addEventListener('change', handleMateriChange);
    elements.simpanAbsenBtn.addEventListener('click', handleSimpanAbsen);
    elements.tambahMateriBtn.addEventListener('click', () => elements.modalTambahMateri.classList.remove('hidden'));
    elements.batalTambahMateriBtn.addEventListener('click', () => elements.modalTambahMateri.classList.add('hidden'));
    elements.simpanTambahMateriBtn.addEventListener('click', handleSimpanMateri);

    // Event listener untuk tombol Hadir Semua, Tambah Siswa, dll, bisa ditambahkan di sini
    // ...
});
</script>

</body>
</html>
